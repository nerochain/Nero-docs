# Integrating the NERO Chain Paymaster in Your Frontend

This tutorial explains how to integrate the NERO Chain Paymaster into your React frontend, allowing your users to execute transactions without paying for gas.

## What You'll Learn
- What a Paymaster is and how it fits into the Account Abstraction model
- How to configure your frontend application to use the NERO Chain Paymaster
- How to implement different payment options for transaction gas
- How to manage Paymaster API keys securely
- How to create a PaymasterProvider component for your React application

## Prerequisites
- Completed the [AA Wallet Integration](/en/tutorials/aa-wallet-integration) tutorial
- Completed the [Sending UserOperations](/en/tutorials/sending-ops) tutorial
- An API key from the [NERO Chain AA Platform](https://aa-platform.nerochain.io)

## What is a Paymaster?

A Paymaster is a service that sponsors transaction gas fees for users. In the Account Abstraction (AA) model, the Paymaster:

1. Reviews a transaction before it's executed
2. Determines if it should sponsor the gas fees
3. Signs the transaction to indicate its willingness to pay
4. Can accept alternative payment methods (like ERC-20 tokens) instead of the native token

## Step 1: Setting Up Paymaster Configuration

First, update your configuration file to include Paymaster settings:

```typescript
// src/config.ts
export const AA_PLATFORM_CONFIG = {
  bundlerRpc: "https://bundler.service.nerochain.io",
  paymasterRpc: "https://paymaster-testnet.nerochain.io",
};

// Your API key from the NERO Chain AA Platform
export let API_KEY: string = "your_api_key_here";

// Store and retrieve the API key
export const setApiKey = (key: string) => {
  API_KEY = key;
  localStorage.setItem('nerochain_api_key', key);
};

export const initApiKey = () => {
  const savedApiKey = localStorage.getItem('nerochain_api_key');
  if (savedApiKey) {
    API_KEY = savedApiKey;
    return true;
  }
  return false;
};
```

## Step 2: Creating the Paymaster Integration

Now, create utility functions for interacting with the Paymaster:

```typescript
// src/utils/aaUtils.ts
import { ethers } from 'ethers';
import { Client, Presets } from 'userop';
import { 
  NERO_CHAIN_CONFIG, 
  AA_PLATFORM_CONFIG, 
  CONTRACT_ADDRESSES,
  API_KEY 
} from '../config';

// Initialize AA Builder with Paymaster
export const initAABuilder = async (accountSigner: ethers.Signer, apiKey?: string) => {
  try {
    // Initialize the SimpleAccount builder
    const builder = await Presets.Builder.SimpleAccount.init(
      accountSigner,
      NERO_CHAIN_CONFIG.rpcUrl,
      {
        overrideBundlerRpc: AA_PLATFORM_CONFIG.bundlerRpc,
        entryPoint: CONTRACT_ADDRESSES.entryPoint,
        factory: CONTRACT_ADDRESSES.accountFactory,
      }
    );
    
    // Set gas parameters from configuration
    const gasParams = {
      callGasLimit: "0x88b8",
      verificationGasLimit: "0x33450",
      preVerificationGas: "0xc350",
      maxFeePerGas: "0x2162553062",
      maxPriorityFeePerGas: "0x40dbcf36",
    };
    
    // Set API key for paymaster - use provided key or global API_KEY
    const currentApiKey = apiKey || API_KEY;
    
    // Set paymaster options with API key
    builder.setPaymasterOptions({
      apikey: currentApiKey,
      rpc: AA_PLATFORM_CONFIG.paymasterRpc,
      type: 0 // Default to free (sponsored gas)
    });
    
    // Set gas parameters for the UserOperation
    builder.setCallGasLimit(gasParams.callGasLimit);
    builder.setVerificationGasLimit(gasParams.verificationGasLimit);
    builder.setPreVerificationGas(gasParams.preVerificationGas);
    builder.setMaxFeePerGas(gasParams.maxFeePerGas);
    builder.setMaxPriorityFeePerGas(gasParams.maxPriorityFeePerGas);
    
    return builder;
  } catch (error) {
    console.error("Error initializing AA builder:", error);
    throw error;
  }
};

// Configure payment type for transactions
export const setPaymentType = (builder: any, paymentType: number, tokenAddress: string = '') => {
  const paymasterOptions: any = { 
    type: paymentType,
    apikey: API_KEY,
    rpc: AA_PLATFORM_CONFIG.paymasterRpc
  };
  
  // Add token address if ERC20 payment is selected
  if (paymentType > 0 && tokenAddress) {
    paymasterOptions.token = tokenAddress;
  }
  
  builder.setPaymasterOptions(paymasterOptions);
  return builder;
};
```

## Step 3: Understanding Payment Types

The NERO Chain Paymaster supports three payment types:

1. **Free (Type 0)**: The developer sponsors all gas costs for the user
2. **Prepay ERC20 (Type 1)**: The user pays with ERC20 tokens upfront
3. **Postpay ERC20 (Type 2)**: The user pays with ERC20 tokens after transaction execution

## Step 4: Creating a Component with Paymaster Options

Create a React component that allows users to select different payment types:

```typescript
// src/components/PaymasterSelector.tsx
import React, { useState } from 'react';
import { setPaymentType } from '../utils/aaUtils';

interface PaymasterSelectorProps {
  builder: any;
  onPaymentTypeChange: (type: number, token?: string) => void;
  supportedTokens: Array<{address: string, symbol: string}>;
}

const PaymasterSelector: React.FC<PaymasterSelectorProps> = ({ 
  builder, 
  onPaymentTypeChange,
  supportedTokens
}) => {
  const [paymentType, setPaymentType] = useState(0);
  const [selectedToken, setSelectedToken] = useState('');

  const handlePaymentTypeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const newType = parseInt(e.target.value);
    setPaymentType(newType);
    
    // Reset token selection when switching to free gas
    if (newType === 0) {
      setSelectedToken('');
      onPaymentTypeChange(newType);
    } else if (selectedToken) {
      onPaymentTypeChange(newType, selectedToken);
    }
    
    // Update builder configuration
    if (builder) {
      setPaymentType(builder, newType, selectedToken);
    }
  };

  const handleTokenChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const token = e.target.value;
    setSelectedToken(token);
    
    if (paymentType > 0) {
      onPaymentTypeChange(paymentType, token);
      
      // Update builder configuration
      if (builder) {
        setPaymentType(builder, paymentType, token);
      }
    }
  };

  return (
    <div className="paymaster-selector">
      <div className="form-group">
        <label>Payment Type:</label>
        <select
          value={paymentType}
          onChange={handlePaymentTypeChange}
          className="select-field"
        >
          <option value={0}>Sponsored (Free Gas)</option>
          <option value={1}>Prepay with ERC20</option>
          <option value={2}>Postpay with ERC20</option>
        </select>
      </div>
      
      {paymentType > 0 && (
        <div className="form-group">
          <label>Token for Gas Payment:</label>
          <select
            value={selectedToken}
            onChange={handleTokenChange}
            className="select-field"
          >
            <option value="">Select a token</option>
            {supportedTokens.map((token) => (
              <option key={token.address} value={token.address}>
                {token.symbol}
              </option>
            ))}
          </select>
        </div>
      )}
    </div>
  );
};

export default PaymasterSelector;
```

## Handling Token Approvals

When using ERC20 tokens for gas payment (types 1 and 2), users need to approve the Paymaster contract to spend their tokens:

```typescript
// Example approval function (add to aaUtils.ts)
export const approveTokenForPaymaster = async (
  signer: ethers.Signer,
  tokenAddress: string,
  tokenPaymasterAddress: string
) => {
  try {
    // Create contract instance
    const erc20Interface = new ethers.Contract(
      tokenAddress,
      [
        'function approve(address spender, uint256 amount) returns (bool)',
        'function allowance(address owner, address spender) view returns (uint256)'
      ],
      signer
    );
    
    // Get the AA wallet address
    const aaWalletAddress = await getAAWalletAddress(signer);
    
    // Check current allowance
    const currentAllowance = await erc20Interface.allowance(
      aaWalletAddress,
      tokenPaymasterAddress
    );
    
    // If allowance is too low, approve more
    if (currentAllowance.lt(ethers.utils.parseUnits("100", 18))) {
      const tx = await erc20Interface.approve(
        tokenPaymasterAddress,
        ethers.constants.MaxUint256
      );
      
      await tx.wait();
      return true;
    }
    
    return true; // Already approved
  } catch (error) {
    console.error("Error approving token for paymaster:", error);
    throw error;
  }
};
```

## Key Considerations

1. **API Key Security**: Never expose your Paymaster API key in client-side code in production. Consider using a backend proxy.
2. **Gas Limits**: The gas parameters should be adjusted based on the complexity of your transactions.
3. **Error Handling**: Implement robust error handling for Paymaster-related failures.
4. **User Experience**: Clearly explain to users the payment options and what they mean.

## Testing Your Paymaster Integration

1. Make sure you have a valid API key from the NERO Chain AA Platform
2. Try executing a transaction with different payment types
3. For token payments, ensure users have sufficient token balance
4. Monitor transaction success and costs through the AA Platform dashboard

## Conclusion

You've now successfully integrated the NERO Chain Paymaster into your application, enabling:

1. **Gasless transactions** for users without NERO tokens
2. **Multiple payment methods** for transaction fees
3. **Better user experience** with AA wallets and sponsored gas
4. **Secure API key management** using environment variables

This implementation provides a foundation for building feature-rich dApps that can onboard users from all backgrounds, regardless of their familiarity with blockchain gas fees.

## Next Steps
Now that you understand how to integrate the Paymaster, you may want to learn about the different types of payments it supports. Continue to the [Payment Methods](/en/tutorials/types-payments) tutorial to explore the various payment options available with the NERO Chain Paymaster.